import csv
import io
import re
from collections import defaultdict
from collections.abc import AsyncIterator
from datetime import datetime, timezone
from typing import Any

import httpx

from .base import (
    Exploit,
    Ingestor,
    NormalizedVulnerability,
    RawVulnerability,
    get_response_with_retry,
)

_CVE_RE = re.compile(r"CVE-\d{4}-\d{4,}")
_CSV_URL = (
    "https://gitlab.com/exploit-database/exploitdb/-/raw/main/files_exploits.csv"
)


class ExploitDBIngestor(Ingestor):
    def source_name(self) -> str:
        return "exploitdb"

    async def fetch_updates(self, since: datetime | None) -> AsyncIterator[list[RawVulnerability]]:
        async with httpx.AsyncClient(timeout=120.0, follow_redirects=True) as client:
            response = await get_response_with_retry(client, _CSV_URL, headers={})

        reader = csv.DictReader(io.StringIO(response.text))
        by_cve: dict[str, list[dict[str, Any]]] = defaultdict(list)

        for row in reader:
            cve_ids = _CVE_RE.findall(row.get("description", ""))
            if not cve_ids:
                continue

            if since:
                date_str = row.get("date_published") or row.get("date", "")
                if date_str:
                    try:
                        pub = datetime.strptime(date_str, "%Y-%m-%d").replace(
                            tzinfo=timezone.utc,
                        )
                        if pub < since:
                            continue
                    except ValueError:
                        pass

            for cve_id in cve_ids:
                by_cve[cve_id].append(row)

        results = [
            RawVulnerability(
                cve_id=cve_id,
                source=self.source_name(),
                raw_data={"cve_id": cve_id, "exploits": rows},
            )
            for cve_id, rows in by_cve.items()
        ]
        if results:
            yield results

    def _normalize(self, raw: dict[str, Any]) -> NormalizedVulnerability:
        cve_id = raw["cve_id"]
        exploits: list[Exploit] = []

        for row in raw.get("exploits", []):
            edb_id = row.get("id", "")
            date_str = row.get("date_published") or row.get("date", "")
            discovered_at = None
            if date_str:
                try:
                    discovered_at = datetime.strptime(date_str, "%Y-%m-%d").replace(
                        tzinfo=timezone.utc,
                    )
                except ValueError:
                    pass

            exploits.append(
                Exploit(
                    source="exploitdb",
                    source_id=edb_id,
                    url=f"https://www.exploit-db.com/exploits/{edb_id}" if edb_id else None,
                    description=row.get("description"),
                    discovered_at=discovered_at,
                ),
            )

        return NormalizedVulnerability(
            cve_id=cve_id,
            source=self.source_name(),
            exploits=exploits,
        )
