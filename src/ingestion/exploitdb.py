import re
from collections import defaultdict
from collections.abc import AsyncIterator
from datetime import datetime
from typing import Any

import asyncpg

from .base import (
    Exploit,
    Ingestor,
    NormalizedVulnerability,
    RawVulnerability,
)

_EDB_RE = re.compile(r"exploit-db\.com/exploits/(\d+)")


class ExploitDBIngestor(Ingestor):
    """Enrich CVEs with Exploit-DB proof-of-concept metadata by scanning
    cve_references for exploit-db.com URLs already collected by other ingestors."""

    def __init__(self, pool: asyncpg.Pool) -> None:
        self.pool = pool

    def source_name(self) -> str:
        return "exploitdb"

    async def fetch_updates(self, since: datetime | None) -> AsyncIterator[list[RawVulnerability]]:
        async with self.pool.acquire() as conn:
            rows = await conn.fetch(
                "SELECT cve_id, url FROM cve_references "
                "WHERE url LIKE '%exploit-db.com/exploits/%'"
            )

        by_cve: dict[str, list[dict[str, str]]] = defaultdict(list)
        for row in rows:
            match = _EDB_RE.search(row["url"])
            if match:
                by_cve[row["cve_id"]].append({
                    "id": match.group(1),
                    "url": row["url"],
                })

        page: list[RawVulnerability] = []
        for cve_id, exploits in by_cve.items():
            page.append(
                RawVulnerability(
                    cve_id=cve_id,
                    source=self.source_name(),
                    raw_data={"cve_id": cve_id, "exploits": exploits},
                )
            )
            if len(page) >= 5000:
                yield page
                page = []
        if page:
            yield page

    def _normalize(self, raw: dict[str, Any]) -> NormalizedVulnerability:
        cve_id = raw["cve_id"]
        exploits = [
            Exploit(
                source="exploitdb",
                source_id=exp["id"],
                url=f"https://www.exploit-db.com/exploits/{exp['id']}",
            )
            for exp in raw.get("exploits", [])
        ]
        return NormalizedVulnerability(
            cve_id=cve_id,
            source=self.source_name(),
            exploits=exploits,
        )
