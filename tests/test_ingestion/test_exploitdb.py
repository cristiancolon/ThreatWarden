from unittest.mock import AsyncMock, MagicMock

from ingestion.exploitdb import ExploitDBIngestor


async def _collect(gen):
    results = []
    async for page in gen:
        results.extend(page)
    return results


def _mock_pool(rows):
    """Create a mock asyncpg pool that returns *rows* from conn.fetch()."""
    conn = AsyncMock()
    conn.fetch = AsyncMock(return_value=rows)
    pool = MagicMock()
    pool.acquire.return_value.__aenter__ = AsyncMock(return_value=conn)
    pool.acquire.return_value.__aexit__ = AsyncMock(return_value=False)
    return pool


_SAMPLE_ROWS = [
    {"cve_id": "CVE-2025-1111", "url": "https://www.exploit-db.com/exploits/10001"},
    {"cve_id": "CVE-2025-2222", "url": "https://www.exploit-db.com/exploits/10002"},
    {"cve_id": "CVE-2025-1111", "url": "https://www.exploit-db.com/exploits/10004"},
]


# ── source_name ───────────────────────────────────────────────────────────


def test_source_name():
    assert ExploitDBIngestor(None).source_name() == "exploitdb"


# ── fetch_updates ─────────────────────────────────────────────────────────


async def test_fetch_groups_by_cve():
    pool = _mock_pool(_SAMPLE_ROWS)
    results = await _collect(ExploitDBIngestor(pool).fetch_updates(since=None))

    cve_ids = {r.cve_id for r in results}
    assert "CVE-2025-1111" in cve_ids
    assert "CVE-2025-2222" in cve_ids


async def test_fetch_merges_multiple_exploits_for_same_cve():
    pool = _mock_pool(_SAMPLE_ROWS)
    results = await _collect(ExploitDBIngestor(pool).fetch_updates(since=None))

    cve_1111 = next(r for r in results if r.cve_id == "CVE-2025-1111")
    assert len(cve_1111.raw_data["exploits"]) == 2


async def test_fetch_extracts_edb_id():
    pool = _mock_pool([
        {"cve_id": "CVE-2025-9999", "url": "https://www.exploit-db.com/exploits/55555"},
    ])
    results = await _collect(ExploitDBIngestor(pool).fetch_updates(since=None))

    assert len(results) == 1
    assert results[0].raw_data["exploits"][0]["id"] == "55555"


async def test_fetch_skips_non_matching_urls():
    pool = _mock_pool([
        {"cve_id": "CVE-2025-0001", "url": "https://example.com/not-exploitdb"},
    ])
    results = await _collect(ExploitDBIngestor(pool).fetch_updates(since=None))

    assert results == []


async def test_fetch_returns_empty_when_no_references():
    pool = _mock_pool([])
    results = await _collect(ExploitDBIngestor(pool).fetch_updates(since=None))

    assert results == []


# ── _normalize ────────────────────────────────────────────────────────────


def test_normalize_creates_exploit_objects():
    raw = {
        "cve_id": "CVE-2025-1111",
        "exploits": [
            {"id": "10001", "url": "https://www.exploit-db.com/exploits/10001"},
        ],
    }
    result = ExploitDBIngestor(None)._normalize(raw)

    assert result.cve_id == "CVE-2025-1111"
    assert result.source == "exploitdb"
    assert len(result.exploits) == 1
    assert result.exploits[0].source == "exploitdb"
    assert result.exploits[0].source_id == "10001"


def test_normalize_builds_exploit_url():
    raw = {
        "cve_id": "CVE-2025-1111",
        "exploits": [{"id": "10001", "url": "https://www.exploit-db.com/exploits/10001"}],
    }
    result = ExploitDBIngestor(None)._normalize(raw)

    assert result.exploits[0].url == "https://www.exploit-db.com/exploits/10001"


def test_normalize_handles_multiple_exploits():
    raw = {
        "cve_id": "CVE-2025-1111",
        "exploits": [
            {"id": "10001", "url": "https://www.exploit-db.com/exploits/10001"},
            {"id": "10002", "url": "https://www.exploit-db.com/exploits/10002"},
        ],
    }
    result = ExploitDBIngestor(None)._normalize(raw)

    assert len(result.exploits) == 2
    assert {e.source_id for e in result.exploits} == {"10001", "10002"}


def test_normalize_empty_exploits():
    raw = {"cve_id": "CVE-2025-0000", "exploits": []}
    result = ExploitDBIngestor(None)._normalize(raw)

    assert result.exploits == []
